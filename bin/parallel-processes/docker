#!/usr/bin/env bash

set -eu

readonly ROOT_DIR="$(realpath "$(dirname "$(realpath "$0")")/../..")"

REPOSITORY_VERSION=
remaining_args=()
for param in "$@"; do
    if [[ "${param}" == --version=* ]]; then
        REPOSITORY_VERSION="${param#--version=}"
    else
        remaining_args+=("${param}")
    fi
done
if [ -z "${REPOSITORY_VERSION}" ]; then
    echo "Error: --version=X.X.X is required"
    exit 1
fi
set -- "${remaining_args[@]+"${remaining_args[@]}"}"

source "${ROOT_DIR}"/config/version/composer-version.env
source "${ROOT_DIR}"/config/docker/parallel-processes-docker-image-name.env
source "${ROOT_DIR}"/bin/theme.inc.bash

title "Build Docker image: ${PARALLEL_PROCESSES_ALPINE_DOCKER_IMAGE_NAME}"
DOCKER_IMAGE_NAME="${PARALLEL_PROCESSES_ALPINE_DOCKER_IMAGE_NAME}" \
DOCKER_FILE_PATH="${ROOT_DIR}"/docker/parallel-processes/Dockerfile.alpine \
DOCKER_BUILD_PARAMS="--build-arg REPOSITORY_VERSION=${REPOSITORY_VERSION}" \
    source "${ROOT_DIR}"/bin/docker-build.inc.bash

title "Build Docker image: ${PARALLEL_PROCESSES_BUSTER_DOCKER_IMAGE_NAME}"
DOCKER_IMAGE_NAME="${PARALLEL_PROCESSES_BUSTER_DOCKER_IMAGE_NAME}" \
DOCKER_FILE_PATH="${ROOT_DIR}"/docker/parallel-processes/Dockerfile.buster \
DOCKER_BUILD_PARAMS="--build-arg REPOSITORY_VERSION=${REPOSITORY_VERSION}" \
    source "${ROOT_DIR}"/bin/docker-build.inc.bash

title "Build Docker image: ${PARALLEL_PROCESSES_BOOKWORM_DOCKER_IMAGE_NAME}"
DOCKER_IMAGE_NAME="${PARALLEL_PROCESSES_BOOKWORM_DOCKER_IMAGE_NAME}" \
DOCKER_FILE_PATH="${ROOT_DIR}"/docker/parallel-processes/Dockerfile.bookworm \
DOCKER_BUILD_PARAMS="--build-arg REPOSITORY_VERSION=${REPOSITORY_VERSION}" \
    source "${ROOT_DIR}"/bin/docker-build.inc.bash

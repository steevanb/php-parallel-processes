#!/usr/bin/env sh

set -eu

readonly rootDir="$(realpath $(dirname $(realpath $0))/..)"

removeComposerLock() {
    if [ -f "${rootDir}/composer.lock" ]; then
        rm "${rootDir}/composer.lock"
    fi
}

if type docker > /dev/null 2>&1; then
    docker \
        run \
            --rm \
            --interactive \
            --tty \
            --volume "${rootDir}":/app \
            --user "$(id -u)":"$(id -g)" \
            --entrypoint bin/"$(basename $0)" \
            --workdir /app \
            --env COMPOSER_HOME=/app/var/composer \
            steevanb/php-parallel-process:ci \
            "${@}"
else
    removeComposerLock
    composer "${@}"
    removeComposerLock
fi

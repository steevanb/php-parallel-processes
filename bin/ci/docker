#!/usr/bin/env bash

set -eu

readonly rootDir=$(realpath "$(dirname "$(realpath "$0")")/../..")

function buildDockerImage() {
    local dockerPhpVersion="${1}"
    local dockerImageName="${2}"

    if [ ${refresh} == true ]; then
        local refreshArguments="--no-cache --pull"
    else
        local refreshArguments=
    fi

    DOCKER_BUILDKIT=1 \
        docker \
            build \
                "${rootDir}"/docker/php-"${dockerPhpVersion}" \
                --tag="${dockerImageName}" \
                ${refreshArguments}
}

function pushDockerImage() {
    local dockerImageName="${1}"

    echo "Push Docker image ${dockerImageName}."
    docker push "${dockerImageName}"
}

refresh=false
push=false
for param in "$@"; do
    if [ "${param}" == "--refresh" ]; then
        refresh=true
    elif [ "${param}" == "--push" ]; then
        push=true
    fi
done

buildDockerImage "7-4" "steevanb/php-parallel-process:phpunit-php-7.4"
buildDockerImage "8-0" "steevanb/php-parallel-process:phpunit-php-8.0"

if [ ${push} == true ]; then
    echo "Login to dockerhub."
    docker logout
    docker login --username=steevanb

    pushDockerImage "steevanb/php-parallel-process:phpunit-php-7.4"
    pushDockerImage "steevanb/php-parallel-process:phpunit-php-8.0"
fi

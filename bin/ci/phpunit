#!/usr/bin/env bash

set -eu

readonly rootDir="$(realpath "$(dirname "$(realpath "$0")")/../..")"
. "${rootDir}/bin/common.inc.sh"

if ! ${IS_IN_DOCKER}; then
    docker \
        run \
            --rm \
            --tty \
            ${DOCKER_INTERACTIVE_PARAMETER} \
            --volume "${rootDir}":/app \
            --user "$(id -u)":"$(id -g)" \
            --entrypoint bin/ci/"$(basename "${0}")" \
            --workdir /app \
            steevanb/php-parallel-process:ci \
            "${@}"
    exit 0
fi

phpVersion=
symfonyVersion=
phpunitParameters=
for arg in "${@}"; do
    if [ "${arg:0:6}" == "--php=" ]; then
        phpVersion="${arg:6}"
    elif [ "${arg:0:10}" == "--symfony=" ]; then
        symfonyVersion="${arg:10}"
    else
        phpunitParameters="${phpunitParameters} ${arg}"
    fi
done

if [ "${phpVersion}" == "" ] || [ "${symfonyVersion}" == "" ]; then
    php8.0 "${rootDir}"/bin/ci/phpunit.php "${@}"
else
    echo "PHP ${phpVersion} - Symfony ${symfonyVersion}"

    "php${phpVersion}" \
        vendor/bin/phpunit \
            --bootstrap "${COMPOSER_HOME_SYMFONY_5_0}"/vendor/autoload.php \
            --configuration config/ci/phpunit.xml \
            ${phpunitParameters}
fi

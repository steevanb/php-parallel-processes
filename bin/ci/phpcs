#!/usr/bin/env sh

set -eu

readonly rootDir="$(realpath "$(dirname "$(realpath "$0")")/../..")"
. "${rootDir}/bin/common.inc.sh"

createCacheDir() {
    if [ ! -d "${rootDir}"/var/ci/phpcs ]; then
        mkdir -p "${rootDir}"/var/ci/phpcs
    fi
}

if ! ${IS_IN_DOCKER}; then
    createCacheDir

    docker \
        run \
            --tty \
            ${DOCKER_INTERACTIVE_PARAMETER} \
            --volume "${rootDir}":/app:ro \
            --volume "${rootDir}"/var/ci/phpcs:/app/var/ci/phpcs \
            --user "$(id -u)":"$(id -g)" \
            --entrypoint bin/ci/"$(basename "${0}")" \
            --workdir /app \
            steevanb/php-parallel-process:ci \
            "${@}"
    exit 0
fi

createCacheDir

phpcs \
    -p \
    --warning-severity=0 \
    --ignore=/vendor/,/var/ \
    --bootstrap=config/ci/phpcs.php \
    --standard="${COMPOSER_HOME}"/vendor/steevanb/php-code-sniffs/src/Steevanb/ruleset.xml \
    --report=steevanb\\PhpCodeSniffs\\Reports\\Steevanb \
    --cache=var/ci/phpcs/cache \
    . \
    "${@}"
